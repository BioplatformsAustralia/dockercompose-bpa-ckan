cache:
  image: memcached:1.4

nginx:
  image: muccg/nginx-uwsgi:1.10
  ports:
    - "8443:443"
    - "8080:80"
  volumes:
    - ./data/nginx:/data
    - ./nginx/sites-enabled/app.conf:/etc/nginx/sites-enabled/app.conf
    - ./nginx/conf.d/app.conf:/etc/nginx/conf.d/app.conf
  links:
      - ckan:uwsgi
      - otu:otu

datastore:
  image: mdillon/postgis:9.6
  ports:
    - 5432
  environment:
    - POSTGRES_USER=datastore
    - POSTGRES_PASSWORD=datastore

db:
  image: mdillon/postgis:9.6
  ports:
    - 5432
  environment:
    - POSTGRES_USER=ckan
    - POSTGRES_PASSWORD=ckan

solr:
  image: muccg/solr-jts:5.5
  ports:
      - "8983:8983"
  volumes:
      - ./solr/ckan:/opt/solr/server/solr/ckan

datapusher:
  image: muccg/bpa-datapusher:latest





otu:
  image: muccg/bpaotu-dev
  environment:
    - POSTGRES_USER=ckan
    - POSTGRES_PASSWORD=ckan
    - WAIT_FOR_DB=1
    - WAIT_FOR_CACHE=1
  links:
    - otu_db
    - otu_datadev
    - otu_cache
    # - otu_uwsgi

otu_datadev:
  image: debian:jessie
  volumes:
    - .:/app
    - ./data/dev:/data

otu_db:
  image: mdillon/postgis:10
  ports:
      - 5432
  environment:
    - POSTGRES_USER=webapp
    - POSTGRES_PASSWORD=webapp

otu_cache:
  image: redis:3-alpine

otu_uwsgi:
  image: muccg/bpaotu-dev
  command: uwsgi_local
  environment:
    - WAIT_FOR_DB=1
    - WAIT_FOR_CACHE=1
    - WAIT_FOR_RUNSERVER=1
    # note: important to wait for runserver in dev as both will attempt to syncdb etc
  ports:
    - "9000:9000"
    - "9001:9001"
    - "9100:9100"
    - "9101:9101"






ckan:
  build: .
  environment:
    - DBUSER=ckan
    - WAIT_FOR_DB=1
    - WAIT_FOR_DATASTORE=1
    - WAIT_FOR_SOLR=1
    - WAIT_FOR_CACHE=1
    - SESSION_SECRET=${SESSION_SECRET}
    - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
    - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    - AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
    - AWS_STORAGE_PATH=${AWS_STORAGE_PATH}
    - MAILGUN_API_KEY=${MAILGUN_API_KEY}
    - MAILGUN_API_DOMAIN=${MAILGUN_API_DOMAIN}
    - MAILGUN_SENDER_EMAIL=${MAILGUN_SENDER_EMAIL}
    - MAILGUN_RECEIVER_EMAIL=${MAILGUN_RECEIVER_EMAIL}
    - REGISTRATION_ERROR_LOG_FILE_PATH=${REGISTRATION_ERROR_LOG_FILE_PATH}
    - REGISTRATION_ERROR_LOG_FILE_NAME=${REGISTRATION_ERROR_LOG_FILE_NAME}
    - GOOGLE_UA=${GOOGLE_UA}
    - CAPTCHA_PUBLIC_KEY=${CAPTCHA_PUBLIC_KEY}
    - CAPTCHA_PRIVATE_KEY=${CAPTCHA_PRIVATE_KEY}
    - BPAM_REGISTRATION_LOG_KEY=${BPAM_REGISTRATION_LOG_KEY}
    - BPAM_REGISTRATION_LOG_URL=${BPAM_REGISTRATION_LOG_URL}
  volumes:
    - ./data/dev:/data
  ports:
    - 9100
    - 9101
  links:
    - db
    - datastore
    - solr
    - cache
    - otu
#    - datapusher
